name: ChromeOS ARCVM - Gensis Build Kernel
on:
  workflow_call:
    inputs:
      kernelsu_variant:
        required: false
        type: string
        default: 'SukiSU'
      use_kpm:
        required: false
        type: boolean
        default: true
      use_zram:
        required: false
        type: boolean
        default: true
      custom_version:
        required: false
        type: string
        default: 'ARCVM-KSU-SUSFS-5.10-245'
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: 'KernelSU Variant'
        required: false
        type: choice
        options:
          - SukiSU
          - Official
        default: 'SukiSU'
      use_kpm:
        description: 'Enable KPM (SukiSU only)'
        required: false
        type: boolean
        default: false
      use_zram:
        description: 'Enable ZRAM/LZ4KD'
        required: false
        type: boolean
        default: true
      custom_version:
        description: 'Custom kernel version suffix'
        required: false
        type: string
        default: 'ARCVM-KSU-SUSFS'

env:
  git_tag: chromeos-5.10-arcvm

jobs:
  build:
    if: github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    strategy:
      matrix:
        include:
          - arch: x86_64
            kernel_image_name: bzImage
            build_config: build.config.gki.x86_64
            defconfig: x86_64_arcvm_defconfig

    name: Build ChromeOS ARCVM kernel
    runs-on: ubuntu-22.04
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-swapfile: 'true'
          remove-cached-tools: 'false'
          verbose: 'true'

      # ===================================================================
      
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc \
              bison build-essential ca-certificates flex git gnupg \
              libelf-dev libssl-dev lsb-release software-properties-common wget \
              libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
              rsync python3 device-tree-compiler ccache python3-setuptools

          sudo ln -s --force python3 /usr/bin/python
          
      # =================================================================== 
       
      - name: Configure ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --version
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV


     # ===================================================================
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: arcvm-${{ env.git_tag }}-ccache-${{ github.sha }}
          restore-keys: |
            arcvm-${{ env.git_tag }}-ccache-


      # ===================================================================
      
      - name: Install Latest ChromeOS-Compatible LLVM Toolchain (LLVM 18)
        run: |
          export LLVM_VERSION=18

          echo "üîß Installing official LLVM $LLVM_VERSION packages..."
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION
          rm ./llvm.sh

          echo "üîó Forcing system to use LLVM $LLVM_VERSION binaries..."
          sudo ln -sf /usr/bin/clang-$LLVM_VERSION        /usr/bin/clang
          sudo ln -sf /usr/bin/clang++-$LLVM_VERSION      /usr/bin/clang++
          sudo ln -sf /usr/bin/ld.lld-$LLVM_VERSION       /usr/bin/ld.lld
          sudo ln -sf /usr/bin/llvm-ar-$LLVM_VERSION      /usr/bin/llvm-ar
          sudo ln -sf /usr/bin/llvm-nm-$LLVM_VERSION      /usr/bin/llvm-nm
          sudo ln -sf /usr/bin/llvm-objdump-$LLVM_VERSION /usr/bin/llvm-objdump
          sudo ln -sf /usr/bin/llvm-objcopy-$LLVM_VERSION /usr/bin/llvm-objcopy
          sudo ln -sf /usr/bin/llvm-strip-$LLVM_VERSION   /usr/bin/llvm-strip
          sudo ln -sf /usr/bin/llvm-readelf-$LLVM_VERSION /usr/bin/llvm-readelf

          echo "üîç Checking LLVM installation:"
          clang --version
          ld.lld --version
          llvm-objcopy --version
          llvm-ar --version

      # ===================================================================
      
      - name: Checkout KernelSU
        uses: actions/checkout@v5
        with:
          path: KernelSU
          fetch-depth: 0
      # ===================================================================
      
      - name: Setup kernel source
        run: git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b ${{ env.git_tag }} --depth=1


      # ===================================================================
      
      - name: Extract version from Makefile
        working-directory: kernel
        run: |
          VERSION=$(grep -E '^VERSION = ' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep -E '^PATCHLEVEL = ' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep -E '^SUBLEVEL = ' Makefile | awk '{print $3}')
          echo "ChromeOS ARCVM Linux kernel version: $VERSION.$PATCHLEVEL.$SUBLEVEL"
          echo "version=$VERSION.$PATCHLEVEL.$SUBLEVEL" >> $GITHUB_ENV


      # =================================================================== 
      - name: Setup KernelSU
        working-directory: kernel
        run: |
          echo "[+] KernelSU setup"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          echo "[+] KERNEL_ROOT: $KERNEL_ROOT"
          echo "[+] Copy KernelSU driver to $KERNEL_ROOT/drivers"
          ln -sf $GITHUB_WORKSPACE/KernelSU/kernel $KERNEL_ROOT/drivers/kernelsu

          echo "[+] Add KernelSU driver to Makefile"
          DRIVER_MAKEFILE=$KERNEL_ROOT/drivers/Makefile
          DRIVER_KCONFIG=$KERNEL_ROOT/drivers/Kconfig
          grep -q "kernelsu" "$DRIVER_MAKEFILE" || printf "\nobj-\$(CONFIG_KSU) += kernelsu/\n" >> "$DRIVER_MAKEFILE"
          grep -q "kernelsu" "$DRIVER_KCONFIG" || sed -i "/endmenu/i\\source \"drivers/kernelsu/Kconfig\"" "$DRIVER_KCONFIG"

          echo "[+] Apply KernelSU patches"
          PATCH_DIR="$GITHUB_WORKSPACE/KernelSU/.github/patches/5.10"
          if [ -d "$PATCH_DIR" ] && [ "$(ls -A $PATCH_DIR/*.patch 2>/dev/null)" ]; then
            cd $KERNEL_ROOT && find $PATCH_DIR -name "*.patch" -exec git apply {} \; 2>/dev/null || echo "[-] Some patches failed to apply"
          else
            echo "[-] No KernelSU patches found, skipping"
          fi

          echo "[+] Patch script/setlocalversion"
          sed -i 's/-dirty//g' $KERNEL_ROOT/scripts/setlocalversion

          echo "[+] KernelSU setup done."
          cd $GITHUB_WORKSPACE/KernelSU
          KSU_VERSION=$(($(git rev-list --count HEAD) + 22000))
          echo "KernelSU version: $KSU_VERSION"
          echo "kernelsu_version=$KSU_VERSION" >> $GITHUB_ENV

      # =================================================================== 
      - name: Clone Dependencies
        run: |
          echo "[+] Cloning required repositories"

          # SUSFS for systemless safety net fix
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-android12-5.10 --depth=1

          # SukiSU patches and scripts
          git clone https://github.com/ShirkNeko/SukiSU_patch.git --depth=1

          # Additional kernel patches
          git clone https://github.com/Tools-cx-app/kernel_patches.git --depth=1

      # ===================================================================    

      - name: Setup KernelSU (${{ inputs.kernelsu_variant }})
        working-directory: kernel
        run: |
          echo "[+] Setting up KernelSU variant: ${{ inputs.kernelsu_variant }}"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel

          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "[+] Installing Official KernelSU"
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "[+] Installing SukiSU"
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          fi

          # Add KernelSU to kernel build
          DRIVER_MAKEFILE=$KERNEL_ROOT/drivers/Makefile
          DRIVER_KCONFIG=$KERNEL_ROOT/drivers/Kconfig
          grep -q "kernelsu" "$DRIVER_MAKEFILE" || printf "\nobj-\$(CONFIG_KSU) += kernelsu/\n" >> "$DRIVER_MAKEFILE"
          grep -q "kernelsu" "$DRIVER_KCONFIG" || sed -i "/endmenu/i\\source \"drivers/kernelsu/Kconfig\"" "$DRIVER_KCONFIG"

          # Apply KernelSU patches
          echo "[+] Applying KernelSU patches for ChromeOS 5.10"
          PATCH_DIR="$GITHUB_WORKSPACE/KernelSU/.github/patches/5.10"
          if [ -d "$PATCH_DIR" ] && [ "$(ls -A $PATCH_DIR/*.patch 2>/dev/null)" ]; then
            cd $KERNEL_ROOT && find $PATCH_DIR -name "*.patch" -exec git apply {} \; 2>/dev/null || echo "[-] Some patches failed to apply"
          else
            echo "[-] No KernelSU patches found, skipping"
          fi

          # Remove dirty tag
          sed -i 's/-dirty//g' scripts/setlocalversion

          # Get KSU version
          cd $GITHUB_WORKSPACE/KernelSU
          KSU_VERSION=$(($(git rev-list --count HEAD) + 22000))
          echo "KernelSU version: $KSU_VERSION"
          echo "kernelsu_version=$KSU_VERSION" >> $GITHUB_ENV

       # ===================================================================    
          
      - name: Fix And Bypass KernelSU KPM issue - drivers/kernelsu/kpm/kpm.c
        working-directory: kernel
        run: |
          FILE="drivers/kernelsu/kpm/kpm.c"
          sed -i 's/strncpy_from_user(\(.*\));/if (strncpy_from_user(\1) < 0) return -EFAULT;/' "$FILE"
          echo "export KCFLAGS=\"\$KCFLAGS -Wno-error\"" >> ../.kcflags_env.sh
          if ! grep -q 'pragma clang diagnostic ignored "-Wunused-result"' "$FILE"; then
            sed -i '1i #pragma clang diagnostic ignored "-Wunused-result"' "$FILE"
          fi

       # ===================================================================    
          
      - name: Apply SUSFS Patches
        working-directory: kernel
        run: |
          echo "[+] Applying SUSFS patches for ChromeOS ARCVM"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel

          # Copy SUSFS kernel patches
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch $KERNEL_ROOT/
          cp -r $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/* $KERNEL_ROOT/fs/
          cp -r $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/* $KERNEL_ROOT/include/linux/

          # Apply variant-specific SUSFS patches
          if [ "${{ inputs.kernelsu_variant }}" == "Official" ]; then
            echo "[+] Applying SUSFS for Official KernelSU"
            cd $GITHUB_WORKSPACE/kernel/KernelSU
            cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 --forward --fuzz=3 < 10_enable_susfs_for_ksu.patch || true
          elif [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "[+] Applying SUSFS for SukiSU"
            cd $GITHUB_WORKSPACE/kernel/KernelSU
            # SukiSU already has SUSFS integrated, minimal patching needed
          fi

          # Apply main SUSFS kernel patch
          echo "[+] Applying main SUSFS kernel patch to kernel"
          cd $KERNEL_ROOT
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-android12-5.10.patch || true

      # ===================================================================     

      - name: Apply ZRAM/LZ4KD Patches
        if: ${{ inputs.use_zram }}
        working-directory: kernel
        run: |
          echo "[+] Adding ZRAM/LZ4KD support"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel

          # Copy LZ4K source files for 5.10
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/include/linux/* $KERNEL_ROOT/include/linux/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/lib/* $KERNEL_ROOT/lib/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k/crypto/* $KERNEL_ROOT/crypto/
          cp -r $GITHUB_WORKSPACE/SukiSU_patch/other/zram/lz4k_oplus $KERNEL_ROOT/lib/

          # Apply LZ4KD patches
          cd $KERNEL_ROOT
          cp $GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4kd.patch ./
          patch -p1 -F 3 < lz4kd.patch || true
          cp $GITHUB_WORKSPACE/SukiSU_patch/other/zram/zram_patch/5.10/lz4k_oplus.patch ./
          patch -p1 -F 3 < lz4k_oplus.patch || true

      - name: Hide Detection Patches
        working-directory: kernel
        run: |
          echo "[+] Applying hide detection patches"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          cd $KERNEL_ROOT

          # Choose patch based on variant
          if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            cp $GITHUB_WORKSPACE/SukiSU_patch/69_hide_stuff.patch ./
          else
            cp $GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch ./
          fi
          patch -p1 -F 3 < 69_hide_stuff.patch || true


      # ===================================================================     

      - name: Configure Custom Arch x86_64 KernelSU + SukiSU + SUSFS Kconfig
        working-directory: kernel
        run: |
          echo "[+] Configuring custom Arch x86_64 KernelSU + SukiSU + SUSFS Kconfig"
          KCONFIG_FILE=$GITHUB_WORKSPACE/kernel/arch/x86/Kconfig

          # Add the KernelSU + SUSFS configuration to the existing x86 Kconfig
          echo '

          # --- KernelSU/SUSFS Configuration ---
          menu "KernelSU and SUSFS Support"

          config KSU
          	bool "KernelSU"
          	default y
          	help
          	  Enable support for KernelSU, a root solution for Android kernels.
          	  This option enables the core functionality of KernelSU.

          if KSU

          config KSU_FS
          	bool "KernelSU Filesystem"
          	default y
          	help
          	  Enable the KernelSU filesystem support.

          config KSU_ALLOWLIST
          	bool "KernelSU Allowlist"
          	default y
          	help
          	  Enable the allowlist feature for KernelSU to control root access.

          config KSU_SUKISU
          	bool "KernelSU Sukisu"
          	default y
          	help
          	  Enable Sukisu support within KernelSU.

          config KSU_DEBUG
          	bool "KernelSU Debugging"
          	default y
          	help
          	  Enable debugging features and messages for KernelSU.

          config KPM
          	bool "Kernel Patch Module (KPM)"
          	default y
          	help
          	  Enable the Kernel Patch Module, a dependency for KernelSU.

          config KSU_SUPERCALLS
          	bool "KernelSU Supercalls"
          	default y
          	help
          	  Enable KernelSU supercalls for advanced functionality.

          config KSU_ENFORCE
          	bool "KernelSU Enforce"
          	default y
          	help
          	  Enable enforcing mode for KernelSU security policies.

          config KSU_PERMISSIVE
          	bool "KernelSU Permissive"
          	default y
          	help
          	  Enable permissive mode for KernelSU, useful for debugging.

          config KSU_CORE_INIT
          	bool "KernelSU Core Init"
          	default y
          	help
          	  Enable core initialization logic for KernelSU.

          config KSU_KSUD_INIT
          	bool "KernelSU KSUD Init"
          	default y
          	help
          	  Enable initialization of the KSUD daemon.

          config KSU_ALLOWLIST_INIT
          	bool "KernelSU Allowlist Init"
          	default y
          	help
          	  Enable initialization of the KernelSU allowlist.

          config KSU_GET_ROOT_PROFILE
          	bool "KernelSU Get Root Profile"
          	default y
          	help
          	  Enable functionality to get the root profile.

          config KSU_MANUAL_HOOK
          	bool "KernelSU Manual Hook"
          	default y
          	help
          	  Enable manual hooking capabilities for KernelSU.

          # SUSFS Configurations
          config KSU_SUSFS
          	bool "SUSFS Support"
          	default y
          	help
          	  Enable SUSFS, a filesystem for hiding kernel modifications.

          if KSU_SUSFS

          config KSU_SUSFS_HAS_MAGIC_MOUNT
          	bool "SUSFS Magic Mount"
          	default y
          	help
          	  Enable magic mount feature in SUSFS.

          config KSU_SUSFS_SUS_PATH
          	bool "SUSFS Path"
          	default y
          	help
          	  Configure the SUSFS path.

          config KSU_SUSFS_SUS_MOUNT
          	bool "SUSFS Mount"
          	default y
          	help
          	  Configure the SUSFS mount point.

          config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          	bool "SUSFS Auto Add KSU Default Mount"
          	default y
          	help
          	  Automatically add the default KSU mount to SUSFS.

          config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          	bool "SUSFS Auto Add Bind Mount"
          	default y
          	help
          	  Automatically add bind mounts to SUSFS.

          config KSU_SUSFS_SUS_KSTAT
          	bool "SUSFS Kstat"
          	default y
          	help
          	  Enable kstat support within SUSFS.

          config KSU_SUSFS_TRY_UMOUNT
          	bool "SUSFS Try Unmount"
          	default y
          	help
          	  Enable attempting to unmount in SUSFS.

          config KSU_SUSFS_SPOOF_UNAME
          	bool "SUSFS Spoof Uname"
          	default y
          	help
          	  Enable uname spoofing in SUSFS.

          config KSU_SUSFS_ENABLE_LOG
          	bool "SUSFS Enable Logging"
          	default y
          	help
          	  Enable logging for SUSFS.

          config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          	bool "SUSFS Hide Symbols"
          	default y
          	help
          	  Hide KernelSU and SUSFS symbols.

          config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          	bool "SUSFS Spoof Cmdline/Bootconfig"
          	default y
          	help
          	  Spoof kernel command line or bootconfig via SUSFS.

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "SUSFS Open Redirect"
          	default y
          	help
          	  Enable open redirect functionality in SUSFS.

          endif # KSU_SUSFS

          endif # KSU

          endmenu
          # --- End KernelSU/SUSFS Configuration ---' >> "$KCONFIG_FILE"

      # ===================================================================     
          
      - name: Configure Custom KernelSU Kconfig
        working-directory: kernel
        run: |
          echo "[+] Configuring custom KernelSU Kconfig"
          KCONFIG_FILE=$GITHUB_WORKSPACE/kernel/drivers/kernelsu/Kconfig

          # Create the custom Kconfig with the specified structure
          cat > "$KCONFIG_FILE" << 'EOF'
          menu "KernelSU"

          config KSU
                tristate "KernelSU function support"
                default y
                help
                  Enable kernel-level root privileges on Android System.

          config KSU_DEBUG
                bool "KernelSU debug mode"
                depends on KSU
                default y
                help
                  Enable KernelSU debug mode.

          config KSU_MULTI_MANAGER_SUPPORT
              bool "Multi KernelSU manager support"
              depends on KSU
              default y
              help
                  Enable multi KernelSU manager support

          config KSU_ALLOWLIST_WORKAROUND
              bool "KernelSU Session Keyring Init workaround"
              depends on KSU
              default n
              help
                Enable session keyring init workaround for problematic devices.

          config KPM
                bool "Enable SukiSU KPM"
                depends on KSU && 64BIT
                select KALLSYMS
                select KALLSYMS_ALL
                default y
                help
                  Enabling this option will activate the KPM feature of SukiSU.

          config KSU_MANUAL_HOOK
              bool "Hook KernelSU manually"
              depends on KSU != m
              help
                If enabled, Hook required KernelSU syscalls with manually-patched function.

          menu "KernelSU - SUSFS"

          config KSU_SUSFS
          	bool "KernelSU addon - SUSFS"
          	depends on KSU
          	depends on THREAD_INFO_IN_TASK
          	default y
          	help
          		Patch and Enable SUSFS to kernel with KernelSU.

          config KSU_SUSFS_SUS_PATH
          	bool "Enable to hide suspicious path (NOT recommended)"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding user-defined paths and sub-paths from system calls.

          config KSU_SUSFS_SUS_MOUNT
          	bool "Enable to hide suspicious mounts"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding user-defined mount paths from /proc/self/[mounts|mountinfo|mountstat].

          config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          	bool "Enable to hide KSU's default mounts automatically (experimental)"
          	depends on KSU_SUSFS_SUS_MOUNT
          	default y
          	help
          		Automatically add KSU's default mounts to sus_mount.

          config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          	bool "Enable to hide suspicious bind mounts automatically (experimental)"
          	depends on KSU_SUSFS_SUS_MOUNT
          	default y
          	help
          		Automatically add binded mounts to sus_mount.

          config KSU_SUSFS_SUS_KSTAT
          	bool "Enable to spoof suspicious kstat"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow spoofing the kstat of user-defined file/directory.

          config KSU_SUSFS_TRY_UMOUNT
          	bool "Enable to use ksu's try_umount"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow using try_umount to umount other user-defined mount paths.

          config KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          	bool "Enable to add bind mounts to ksu's try_umount automatically (experimental)"
          	depends on KSU_SUSFS_TRY_UMOUNT
          	default y
          	help
          		Automatically add binded mounts to ksu's try_umount.

          config KSU_SUSFS_SPOOF_UNAME
          	bool "Enable to spoof uname"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow spoofing the string returned by uname syscall.

          config KSU_SUSFS_ENABLE_LOG
          	bool "Enable logging susfs log to kernel"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow logging susfs log to kernel.

          config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          	bool "Enable to automatically hide ksu and susfs symbols from /proc/kallsyms"
          	depends on KSU_SUSFS
          	default y
          	help
          		Automatically hide ksu and susfs symbols from '/proc/kallsyms'.

          config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          	bool "Enable to spoof /proc/cmdline or /proc/bootconfig"
          	depends on KSU_SUSFS
          	default y
          	help
          		Spoof the output of /proc/cmdline or /proc/bootconfig with user-defined file.

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "Enable to redirect a path to be opened with another path (experimental)"
          	depends on KSU_SUSFS
          	default n
          	help
          		Allow redirecting a target path to be opened with another user-defined path.

          config KSU_SUSFS_SUS_MAP
          	bool "Enable to hide some mmapped real file from proc maps interfaces"
          	depends on KSU_SUSFS
          	default y
          	help
          		Allow hiding mmapped real file from /proc/<pid>/[maps|smaps|smaps_rollup|map_files|mem|pagemap]

          endmenu

          endmenu
          EOF


     # ===================================================================
 
      - name: Add Kernel Configuration Options  - x86_64_arcvm_defconfig
        working-directory: kernel
        run: |
          echo "[+] Adding comprehensive kernel configuration options"
          CONFIG_FILE="arch/x86/configs/x86_64_arcvm_defconfig"

          # KernelSU base configs
          echo "CONFIG_KSU=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_DEBUG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> $CONFIG_FILE

          # KPM for SukiSU
          if [ "${{ inputs.use_kpm }}" == "true" ]; then
            echo "CONFIG_KPM=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS_ALL=y" >> $CONFIG_FILE
          fi

          # SUSFS configs (all enabled as specified)
          echo "CONFIG_KSU_SUSFS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $CONFIG_FILE

          # TMPFS extended attributes
          echo "CONFIG_TMPFS_XATTR=y" >> $CONFIG_FILE
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONFIG_FILE

          # Network configs
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $CONFIG_FILE

          # BBR congestion control
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $CONFIG_FILE
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONFIG_FILE
          echo "CONFIG_NET_SCH_FQ=y" >> $CONFIG_FILE

          # ZRAM configs
          if [ "${{ inputs.use_zram }}" == "true" ]; then
            echo "CONFIG_ZSMALLOC=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZO=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4HC=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4KD=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_842=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_WRITEBACK=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $CONFIG_FILE
          fi

        # ===================================================================   

      - name: Add Kernel Configuration Options gki_defconfig
        working-directory: kernel
        run: |
          echo "[+] Adding comprehensive kernel configuration options"
          CONFIG_FILE="arch/x86/configs/gki_defconfig"

          # KernelSU base configs
          echo "CONFIG_KSU=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_DEBUG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> $CONFIG_FILE

          # KPM for SukiSU
          if [ "${{ inputs.use_kpm }}" == "true" ]; then
            echo "CONFIG_KPM=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS=y" >> $CONFIG_FILE
            echo "CONFIG_KALLSYMS_ALL=y" >> $CONFIG_FILE
          fi

          # SUSFS configs (all enabled as specified)
          echo "CONFIG_KSU_SUSFS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $CONFIG_FILE
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> $CONFIG_FILE

          # TMPFS extended attributes
          echo "CONFIG_TMPFS_XATTR=y" >> $CONFIG_FILE
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $CONFIG_FILE

          # Network configs
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $CONFIG_FILE
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $CONFIG_FILE

          # BBR congestion control
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $CONFIG_FILE
          echo "CONFIG_TCP_CONG_BBR=y" >> $CONFIG_FILE
          echo "CONFIG_NET_SCH_FQ=y" >> $CONFIG_FILE

          # ZRAM configs
          if [ "${{ inputs.use_zram }}" == "true" ]; then
            echo "CONFIG_ZSMALLOC=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZO=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4HC=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4KD=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_842=y" >> $CONFIG_FILE
            echo "CONFIG_CRYPTO_LZ4K_OPLUS=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_WRITEBACK=y" >> $CONFIG_FILE
            echo "CONFIG_ZRAM_DEF_COMP_LZ4KD=y" >> $CONFIG_FILE
          fi

      

        # ===============================================================
        #  GUARANTEED KernelSU KPM FIX + SANITY-CHECK + SAFE BUILD
        # ===============================================================
        
      - name: Patch KernelSU KPM (Guaranteed Before Build)
        working-directory: kernel
        run: |
            FILE="drivers/kernelsu/kpm/kpm.c"
        
            echo "üîç Checking if KPM file exists..."
            if [ ! -f "$FILE" ]; then
              echo "‚ùå ERROR: $FILE not found. KPM cannot be patched."
              exit 1
            fi
        
            echo "üõ† Applying KernelSU KPM Patch (safe wrap for strncpy_from_user)..."
            # Patch all strncpy_from_user() calls to check return value
            sed -i 's/strncpy_from_user(\(.*\));/if (strncpy_from_user(\1) < 0) return -EFAULT;/' "$FILE"
        
            echo "üõ° Adding pragma ignore for fallback..."
            if ! grep -q 'pragma clang diagnostic ignored "-Wunused-result"' "$FILE"; then
              sed -i '1i #pragma clang diagnostic ignored "-Wunused-result"' "$FILE"
            fi
        
            echo "‚öôÔ∏è Enforcing KCFLAGS=-Wno-error globally..."
            echo 'KCFLAGS += -Wno-error' >> scripts/Makefile.extrawarn || true
        
            # =====================================================
            #                SANITY-CHECK SECTION
            # =====================================================
        
            echo "üîé Running KPM sanity-check 1: ensure patch applied..."
            if ! grep -q '< 0) return -EFAULT' "$FILE"; then
              echo "‚ùå ERROR: KPM return-value patch NOT applied correctly."
              exit 1
            fi
        
            echo "üîé Running KPM sanity-check 2: ensure pragma exists..."
            if ! grep -q 'ignored "-Wunused-result"' "$FILE"; then
              echo "‚ùå ERROR: pragma suppress NOT applied."
              exit 1
            fi
        
            echo "üîé Running KPM sanity-check 3: ensure Werror disabled..."
            if ! grep -q 'Wno-error' scripts/Makefile.extrawarn; then
              echo "‚ùå ERROR: -Wno-error not injected into Makefile system."
              exit 1
            fi
        
            echo "‚úÖ KPM patching and sanity-checks COMPLETE."
        
        # ===================================================================
        
      - name: Configure Kernel Version
        working-directory: kernel
        run: |
          # Apply custom version suffix (default: ARCVM-KSU-SUSFS)
          echo "Using custom version suffix: ${{ inputs.custom_version }}"
          sed -i "s/^EXTRAVERSION.*/EXTRAVERSION = -${{ inputs.custom_version }}/" Makefile
          sed -i 's/-dirty//' scripts/setlocalversion

        # ===================================================================

      - name: Upload Modified Kernel Source (Debug)
        uses: actions/upload-artifact@v5
        with:
          name: Modified-Kernel-Source-${{ env.version }}-Debug
          path: kernel/
          if-no-files-found: error
          
       # ===================================================================  
       
       # Build Kernel fixed avoid CC being polluted by flags
      - name: Build Kernel (fixed avoid CC being polluted by flags)
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          set -a && . ${{ matrix.build_config }}; set +a
          export DEFCONFIG=${{ matrix.defconfig }}

          if [ ! -z ${{ vars.EXPECTED_SIZE }} ] && [ ! -z ${{ vars.EXPECTED_HASH }} ]; then
            export KSU_EXPECTED_SIZE=${{ vars.EXPECTED_SIZE }}
            export KSU_EXPECTED_HASH=${{ vars.EXPECTED_HASH }}
          fi

          echo "==> DEBUG: show any pre-existing CC/CFLAGS in environment"
          echo "ENV CC: '$CC'"
          echo "ENV KCFLAGS: '$KCFLAGS'"
          echo "ENV KBUILD_CFLAGS: '$KBUILD_CFLAGS'"
          echo "ENV KCPPFLAGS: '$KCPPFLAGS'"

          # -------------------------------
          # Ensure a clean compiler name (no appended flags)
          # -------------------------------
          unset CC CXX HOSTCC HOSTCXX
          export CC=clang
          export CXX=clang++
          export HOSTCC=clang
          export HOSTCXX=clang++

          # Export precise LLVM toolchain helpers (ensure these are the installed llvm-18 binaries)
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export LD=ld.lld

          echo "Using compiler binary: $(which $CC) ($( $CC --version | head -n1 ))"
          echo "Using linker binary: $(which $LD) ($( $LD --version | head -n1 ))"

          # -------------------------------
          # Pass flags directly on the make command line
          # Use KCPPFLAGS for preprocessor flags (affects both C and assembly)
          # -------------------------------
          MAKE_KCFLAGS="-Wno-error"
          MAKE_KCPPFLAGS="-Wno-error"
          MAKE_KBUILD_CFLAGS="-Wno-error"

          echo "Building with KCFLAGS='$MAKE_KCFLAGS', KCPPFLAGS='$MAKE_KCPPFLAGS', KBUILD_CFLAGS='$MAKE_KBUILD_CFLAGS'"

          # ==========================================================
          #  CLEAN (pass flags to make invocation; don't export them)
          # ==========================================================
          make LLVM=1 LLVM_IAS=1 \
              CC=$CC HOSTCC=$HOSTCC LD=$LD \
              AR=$AR NM=$NM OBJCOPY=$OBJCOPY OBJDUMP=$OBJDUMP STRIP=$STRIP \
              KCFLAGS="$MAKE_KCFLAGS" KCPPFLAGS="$MAKE_KCPPFLAGS" KBUILD_CFLAGS="$MAKE_KBUILD_CFLAGS" \
              DEPMOD=depmod DTC=dtc \
              O=${PWD} mrproper

          # ==========================================================
          #  DEFCONFIG (same: pass flags inline)
          # ==========================================================
          make LLVM=1 LLVM_IAS=1 \
              CC=$CC HOSTCC=$HOSTCC LD=$LD \
              AR=$AR NM=$NM OBJCOPY=$OBJCOPY OBJDUMP=$OBJDUMP STRIP=$STRIP \
              KCFLAGS="$MAKE_KCFLAGS" KCPPFLAGS="$MAKE_KCPPFLAGS" KBUILD_CFLAGS="$MAKE_KBUILD_CFLAGS" \
              DEPMOD=depmod DTC=dtc \
              O=${PWD} ${DEFCONFIG} < /dev/null

          # Apply LTO config
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO

          # ==========================================================
          #  BUILD KERNEL (Werror disabled, pass flags IN-LINE)
          # ==========================================================
          echo "üöÄ Building kernel with LLVM and Werror disabled‚Ä¶"

          make LLVM=1 LLVM_IAS=1 \
              CC=$CC HOSTCC=$HOSTCC LD=$LD \
              AR=$AR NM=$NM OBJCOPY=$OBJCOPY OBJDUMP=$OBJDUMP STRIP=$STRIP \
              KCFLAGS="$MAKE_KCFLAGS" KCPPFLAGS="$MAKE_KCPPFLAGS" KBUILD_CFLAGS="$MAKE_KBUILD_CFLAGS" \
              DEPMOD=depmod DTC=dtc \
              O=${PWD} -j$(nproc) \
              ${KERNEL_IMAGE_NAME} modules prepare-objtool 2>&1 | tee ../kernel_build.log

          # output artifacts path (if produced)
          ls -l -h ${PWD}/arch/${ARCH}/boot || true
          echo "file_path=${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV


        
        
        # ===================================================================
        
      - name: Show last 200 build lines on failure (diagnostic)
        if: failure()
        run: |
            echo "==== KERNEL BUILD FAILED ===="
            tail -n 200 kernel_build.log
            
        # ===================================================================

      - name: Upload kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}
        uses: actions/upload-artifact@v5
        with:
          name: kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}
          path: "${{ env.file_path }}"

        # ===================================================================
           
      - name: Patch bzImage for KPM
        if: ${{ inputs.use_kpm && inputs.kernelsu_variant == 'SukiSU' }}
        working-directory: kernel
        run: |
          echo "[+] Patching bzImage for KPM support"
          cd arch/x86/boot/

          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch
          chmod 777 patch
          ./patch || true

          if [ -f "obzImage" ]; then
            rm -rf bzImage
            mv obzImage bzImage
            echo "[+] KPM patching completed"
          fi

      # ===================================================================
      
      - name: Create Simple Kernel Zip
        run: |
          echo "[+] Creating kernel package zip"
          KERNEL_PATH="${{ github.workspace }}/kernel/arch/x86/boot/bzImage"
          ZIP_NAME="ARCVM-${{ env.version }}-${{ inputs.kernelsu_variant }}-${{ inputs.custom_version }}.zip"

          mkdir kernel_package
          cp "$KERNEL_PATH" kernel_package/
          echo "# ARCVM Kernel with KernelSU+SUSFS" > kernel_package/README.md
          echo "## Kernel Information" >> kernel_package/README.md
          echo "- Version: ${{ env.version }}" >> kernel_package/README.md
          echo "- Variant: ${{ inputs.kernelsu_variant }}" >> kernel_package/README.md
          echo "- Features: SUSFS, ZRAM=${{ inputs.use_zram }}, KPM=${{ inputs.use_kpm }}" >> kernel_package/README.md

          zip -r "$ZIP_NAME" kernel_package/
          echo "kernel_zip=$ZIP_NAME" >> $GITHUB_ENV
          
     # ===================================================================

      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ARCVM-KernelSU-SUSFS-${{ inputs.kernelsu_variant }}-${{ env.version }}
          path: |
            ${{ env.file_path }}
            ${{ env.kernel_zip }}
